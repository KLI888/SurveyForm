<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2JQykAtfO8DVSwXnqKxVG_OzJCxryJf0"></script>


    <style>
        #popupMap {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        #popupMap .map-container {
            position: relative;
            width: 80%;
            height: 80%;
            background-color: white;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <main>
        <section class="main_section">
            <form action="" method="post" class="survey_form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form_heading">
                    <h1>Jalgaon.Com Survey</h1>
                </div>
                <div class="form_inputs">
                    <div class="name_input">
                        <div>
                            <label for="">Name</label>
                            <input name='name' type="text" placeholder="Name">
                        </div>
                        <div>
                            <label for="">Legal Name</label>
                            <input name='legal_name' type="text" placeholder="Legal Name">
                        </div>
                    </div>
                    <div class="desc_input">
                        <label for="">Description</label>
                        <textarea name='description' rows="4" name="description" id="" placeholder="Description"></textarea>
                    </div>
                    <div class="main_category_input">
                        <label for="">Main Category</label>
                        <select name="main_category" id="main_category" class="select2">
                            {% for category in main_category %}
                            <option value="{{category.main_category}}">{{category.main_category}}</option>
                            {% endfor %}
                            
                        </select>
                    </div>
                    <div class="sub_category_input">
                        <label for="">Subcategory</label>
                        <select name="sub_category" id="sub_category" class="select2">
                        </select>
                    </div>
                    <div class="upload_media_input">
                        <label for="">Upload Media</label>
                        <input  name='media_file' type="file" id="">
                    </div>
                    <div class="owner_name_input">
                        <label for="">Owner Name</label>
                        <input  name='owner_name' type="text" placeholder="Owner Name">
                    </div>
                    <div class="owner_number_input">
                        <label for="">Owner Mobile No.</label>
                        <input name='owner_no' type="text" placeholder="Owner Mobile No.">
                    </div>
                    <div class="email_input">
                        <label for="">Email</label>
                        <input  name='email' type="text" placeholder="Email">
                    </div>
                    <div class="address_input">
                        <label for="">Address</label>
                        <input name='address' type="text" placeholder="Address">
                    </div>
                    <div class="sub_category_input">
                        <label for="">Survey Taken BY</label>
                        <select name="survey_taken_by" id="survey_taken_by" class="select2">
                            {% for officer in survey_officer %}
                            <option value="{{officer.surver_officer_id}}">{{officer.surver_officer_id}}</option>
                            {% endfor %}
                            
                        </select>
                    </div>
                    <div class="sub_category_input">
                        <label for="">Mediclaim</label>
                        <select name="mediclaim_validity" id="mediclaim_validity" class="select2">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                            <option value="na">N/A</option>
                        </select>
                    </div>
                    <div class="current_location_input">
                        <label for="">Current Location</label>
                        <div id="location_btn"><i class="ri-map-pin-line"></i> Get Current Location
                            <div class="location" id="location"></div>
                        </div>
                        <input type="hidden" name="current_location" id="current_location">

                    </div>
                    <div class="form_submit_btn">
                        <input type="submit" value="SEND">
                    </div>
                </div>
                <div id="map_url" style="visibility: hidden;"></div>
            </form>
        </section>
        <div id="popupMap">
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </main>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize Select2 for all select elements with the class 'select2'
            $('.select2').select2();

            // Define the subcategories as a JSON object for better handling of special characters
            const subCategories = {{ sub_categories_json|safe }};

            console.log("Subcategories Object:", subCategories);

            // Function to populate subcategories based on the selected main category
            function populateSubCategories(mainCategory) {
                const subCategorySelect = $('#sub_category');
                subCategorySelect.empty(); // Clear existing options
                // subCategorySelect.append(new Option('Select a subcategory', '')); // Add placeholder option

                // Check if the mainCategory exists in the subCategories object
                if (subCategories[mainCategory]) {
                    subCategories[mainCategory].forEach(subCat => {
                        subCategorySelect.append(new Option(subCat.text, subCat.id));
                    });
                }
                subCategorySelect.trigger('change'); // Notify Select2 to re-render the options
            }

            // Event handler for the main category dropdown change
            $('#main_category').change(function () {
                const selectedMainCategory = $(this).val();
                console.log("Selected Main Category:", selectedMainCategory);
                populateSubCategories(selectedMainCategory);
            });

            // Initialize subcategory options based on the default selected main category
            const initialMainCategory = $('#main_category').val();
            console.log("Initial Main Category:", initialMainCategory);
            populateSubCategories(initialMainCategory);

            // Show the map popup when the location button is clicked
            $('#location_btn').click(function () {
                showMap();
            });
        });
    </script>

    <script>
        let map;
        let marker;
        let watchID;

        function initMap() {
            const jalgaonCoords = {lat: 21.007657, lng: 75.562603}; // Coordinates of Jalgaon district

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: jalgaonCoords
            });

            document.getElementById('location_btn').addEventListener('click', function() {
                if (navigator.geolocation) {
                    watchID = navigator.geolocation.watchPosition(function(position) {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        if (!marker) {
                            marker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                title: 'You are here'
                            });
                        } else {
                            marker.setPosition(pos);
                        }

                        map.setCenter(pos);

                        // Create Google Map link
                        const locationUrl = `https://www.google.com/maps/search/?api=1&query=${pos.lat},${pos.lng}`;
                        document.getElementById('current_location').value = locationUrl;
                        document.getElementById('location').innerHTML = `<a href="${locationUrl}" target="_blank">View on google map</a>`;
                    }, function(error) {
                        handleLocationError(error);
                    }, {
                        enableHighAccuracy: true, // Use high accuracy if available
                        timeout: 5000, // Timeout to get the location
                        maximumAge: 0 // Don't use cached location
                    });
                } else {
                    handleLocationError({ code: 0 });
                }
            });
        }

        function handleLocationError(error) {
            let message = 'Error: Your browser doesn\'t support geolocation.';
            if (error) {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'User denied the request for Geolocation.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        message = 'The request to get user location timed out.';
                        break;
                    case error.UNKNOWN_ERROR:
                        message = 'An unknown error occurred.';
                        break;
                }
            }
            alert(message);
        }

        // Initialize map after the page loads
        window.onload = initMap;
    </script>
    
</body>

</html>
